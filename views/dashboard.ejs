<%- include('partials/header', { title: title, page: page }) %>
<%- include('partials/navbar') %>
<div class="flex-wrapper">
  <div class="container content">
    <!-- Informasi URL Google Maps yang dikonfigurasi -->
    <div class="row mt-4 mb-3">
      <div class="col-12">
        <% if (!googleMapsUrl) { %>
        <!-- Peringatan jika URL Google Maps belum dikonfigurasi -->
        <div class="card border-warning shadow-sm">
          <div class="card-body p-2">
            <div class="d-flex align-items-center">
              <div class="flex-shrink-0 me-2">
                <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 1.5rem;"></i>
              </div>
              <div class="flex-grow-1 mx-2">
                <h6 class="mb-0">URL Google Maps belum dikonfigurasi</h6>
              </div>
              <div class="flex-shrink-0">
                <a href="/reviews" class="btn btn-sm btn-outline-warning">Lihat Ulasan</a>
              </div>
            </div>
          </div>
        </div>
        <% } else if (placeName) { %>
        <!-- Informasi lokasi dari URL Google Maps -->
        <div class="card border-primary shadow-sm">
          <div class="card-body p-2">
            <div class="d-flex align-items-center">
              <div class="flex-shrink-0 me-2">
                <div class="bg-primary bg-opacity-10 rounded-circle p-1">
                  <i class="bi bi-geo-alt-fill text-primary" style="font-size: 1.25rem;"></i>
                </div>
              </div>
              <div class="flex-grow-1 mx-2">
                <h6 class="mb-0">Lokasi: <span class="text-primary"><%= placeName %></span></h6>
              </div>
              <div class="flex-shrink-0">
                <a href="/reviews" class="btn btn-sm btn-outline-primary">Lihat Ulasan</a>
              </div>
            </div>
          </div>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Kartu-kartu statistik sentimen -->
    <div class="row justify-content-center mt-4">
      <!-- Kartu untuk total ulasan -->
      <div class="col-lg-2 col-md-4 col-6 mb-4">
        <div class="card h-100">
          <div class="card-body text-center">
            <h6 class="card-subtitle mb-2 text-muted">Total Ulasan</h6>
            <h3 class="card-title" id="totalReviews">0</h3>
            <div class="progress mt-2" style="height: 4px;">
              <div class="progress-bar bg-secondary" style="width: 100%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Kartu untuk masing-masing jenis sentimen -->
      <% const sentimentCards = ['positif', 'negatif', 'netral', 'puas', 'kecewa']; %>
      <% sentimentCards.forEach(sentiment => { %>
      <div class="col-lg-2 col-md-4 col-6 mb-4">
        <div class="card h-100">
          <div class="card-body text-center">
            <h6 class="card-subtitle mb-2 text-muted"><%= sentiment.charAt(0).toUpperCase() + sentiment.slice(1) %></h6>
            <h3 class="card-title" id="<%= sentiment %>Count">0</h3>
            <div class="progress mt-2" style="height: 4px;">
              <div class="progress-bar" id="<%= sentiment %>Progress" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
      <% }); %>
    </div>

    <!-- Chart visualisasi distribusi sentimen -->
    <div class="row justify-content-center">
      <div class="col-md-12 mb-4">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Distribusi Sentimen</h5>
          </div>
          <div class="card-body text-center">
            <div class="chart-container" style="position: relative; width: 100%; height: 300px;">
              <canvas id="sentimentChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Daftar ulasan buruk terbaru -->
    <div class="row justify-content-center">
      <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center flex-wrap bg-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-exclamation-diamond-fill me-2 text-danger"></i>
              Ulasan Buruk Terbaru
            </h5>
          </div>
          <div class="card-body p-0">
            <% if (latestBadReviews && latestBadReviews.length > 0) { %>
              <!-- Tampilkan ulasan buruk jika ada -->
              <div class="list-group list-group-flush">
                <% latestBadReviews.forEach((review, index) => { %>
                  <div class="list-group-item <%= index % 2 === 0 ? 'bg-light bg-opacity-50' : '' %>">
                    <div class="d-flex w-100 justify-content-between">
                      <h6 class="mb-1">
                        <span class="badge rounded-pill" style="background-color: <%= review.sentiment === 'negatif' ? '#B71C1C' : '#E65100' %>;">
                          <%= review.sentiment %>
                        </span>
                      </h6>
                      <small class="text-muted"><i class="bi bi-calendar me-1"></i><%= new Date(review.time_published).toLocaleDateString('id-ID') %></small>
                    </div>
                    <p class="mb-1 text-wrap"><%= review.review %></p>
                  </div>
                <% }); %>
              </div>
            <% } else { %>
              <!-- Pesan jika tidak ada ulasan buruk -->
              <div class="alert alert-info m-3">
                <i class="bi bi-info-circle me-2"></i>
                Tidak ada ulasan buruk terbaru.
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('./partials/footer') %>

<!-- Script untuk inisialisasi dan manipulasi chart -->
<script src="/js/chart.umd.js"></script>
<script>
  // Objek Dashboard dengan metode dan konfigurasi
  const Dashboard = {
    // Konfigurasi dashboard termasuk data statistik dan warna sentimen
    config: {
      stats: <%- JSON.stringify(stats) %>,
      placeName: <%- JSON.stringify(placeName || '') %>,
      colors: {
        'positif': 'rgba(46, 125, 50, 0.8)',
        'negatif': 'rgba(183, 28, 28, 0.8)',
        'netral': 'rgba(66, 66, 66, 0.8)',
        'puas': 'rgba(13, 71, 161, 0.8)',
        'kecewa': 'rgba(230, 81, 0, 0.8)'
      }
    },

    // Inisialisasi dashboard saat page load
    init: function() {
      const labels = this.config.stats.labels;
      const allTimeData = labels.map(label => this.config.stats.allTimeCounts[label]);

      this.setupUIElements();
      this.updateSentimentCards(labels, allTimeData);
      this.createAllTimeChart(labels, allTimeData);
    },

    // Setup elemen UI pada dashboard
    setupUIElements: function() {
      this.applyProgressBarColors();
      document.querySelectorAll('canvas').forEach(canvas => {
        canvas.style.cursor = 'pointer';
      });
    },

    // Terapkan warna pada progress bar berdasarkan jenis sentimen
    applyProgressBarColors: function() {
      Object.keys(this.config.colors).forEach(sentiment => {
        const progressBar = document.getElementById(`${sentiment}Progress`);
        if (progressBar) {
          progressBar.style.backgroundColor = this.config.colors[sentiment];
        }
      });
    },

    // Update kartu statistik sentimen dengan data dan persentase
    updateSentimentCards: function(labels, data) {
      const totalReviews = data.reduce((sum, current) => sum + current, 0);

      document.getElementById('totalReviews').textContent = totalReviews;

      labels.forEach((label, index) => {
        const count = data[index];
        const percentage = totalReviews > 0 ? Math.round((count / totalReviews) * 100) : 0;

        document.getElementById(`${label}Count`).textContent = count;

        const progressBar = document.getElementById(`${label}Progress`);
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
      });
    },

    // Buat chart distribusi sentimen
    createAllTimeChart: function(labels, data) {
      this.createSentimentChart(labels, data, 'sentimentChart', 'bar');
    },

    // Handler click pada chart untuk navigasi ke halaman ulasan dengan filter
    handleChartClick: function(chartId, sentiment) {
      window.location.href = `/reviews?sentiment=${sentiment}`;
    },

    // Fungsi untuk membuat chart sentimen dengan konfigurasi tertentu
    createSentimentChart: function(labels, data, chartId, chartType) {
      const ctx = document.getElementById(chartId).getContext('2d');
      const backgroundColors = labels.map(label => this.config.colors[label]);
      const self = this;

      const datasets = chartType === 'pie' ? [{
          label: 'Jumlah Ulasan',
          data: data,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
          borderWidth: 1,
          hoverOffset: 15
        }] :
        labels.map((label, index) => ({
          label: label.charAt(0).toUpperCase() + label.slice(1),
          data: [data[index]],
          backgroundColor: backgroundColors[index],
          borderColor: backgroundColors[index].replace('0.8', '1'),
          borderWidth: 1,
          barPercentage: 0.7,
          categoryPercentage: 0.9
        }));

      new Chart(ctx, {
        type: chartType,
        data: {
          labels: chartType === 'pie' ?
            labels.map(label => label.charAt(0).toUpperCase() + label.slice(1)) : [''],
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            animateRotate: true,
            animateScale: true
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              let sentiment;

              if (chartType === 'pie') {
                const index = elements[0].index;
                sentiment = labels[index];
              } else {
                const datasetIndex = elements[0].datasetIndex;
                sentiment = labels[datasetIndex];
              }

              self.handleChartClick(chartId, sentiment);
            }
          },
          plugins: {
            title: {
              display: true,
              text: `Analisis Sentimen ${self.config.placeName ? '- ' + self.config.placeName : ''}`,
              font: {
                size: 16,
                weight: 'bold'
              }
            },
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                boxWidth: 12,
                padding: 15,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = data.reduce((sum, val) => sum + val, 0);
                  const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                  return `${context.raw} ulasan (${percentage}%)`;
                },
                title: function(context) {
                  return context[0].label;
                }
              }
            }
          },
          scales: chartType === 'bar' ? {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          } : undefined
        }
      });
    }
  };

  // Inisialisasi dashboard saat DOM telah dimuat
  document.addEventListener('DOMContentLoaded', function() {
    Dashboard.init();
  });
</script>